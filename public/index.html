<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>NETSEC WARGAMES</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root { --bg: #050505; --panel: rgba(10, 20, 10, 0.85); --glow: #00ff7f; --danger: #ff3333; --muted: #446644; }
    * { box-sizing: border-box; }
    html,body { height: 100%; margin: 0; background: var(--bg); font-family: "Courier New", monospace; color: var(--glow); overflow: hidden; }
    
    /* Layout */
    .app { display: flex; height: 100%; width: 100%; }
    .sidebar { width: 300px; border-right: 1px solid #004400; padding: 20px; display: flex; flex-direction: column; background: rgba(0,20,0,0.3); }
    .main { flex: 1; display: flex; flex-direction: column; padding: 20px; position: relative; }
    .top-bar { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid var(--muted); padding-bottom: 10px; }

    /* Components */
    h1, h2, h3 { margin: 0 0 10px 0; font-weight: normal; letter-spacing: 1px; text-transform: uppercase; }
    .panel { border: 1px solid var(--muted); background: var(--panel); padding: 15px; margin-bottom: 20px; border-radius: 4px; }
    
    input, select { background: #001100; border: 1px solid var(--muted); color: var(--glow); padding: 5px; font-family: inherit; width: 100%; margin-bottom: 5px; }
    button { background: var(--muted); color: #000; border: none; padding: 8px; cursor: pointer; font-weight: bold; font-family: inherit; width: 100%; transition: 0.2s; }
    button:hover { background: var(--glow); }
    button.danger { background: #500; color: #fff; }
    button.danger:hover { background: var(--danger); }

    /* Logs */
    .console-log { flex: 1; background: #000; border: 1px solid var(--muted); padding: 10px; overflow-y: auto; font-size: 12px; white-space: pre-wrap; opacity: 0.9; }
    .log-entry { margin-bottom: 2px; }
    .log-fw { color: #ffff00; }
    .log-err { color: var(--danger); }
    
    /* Player List */
    .player-item { padding: 8px; border-bottom: 1px solid #112211; cursor: pointer; }
    .player-item:hover { background: #002200; }
    .player-item.hacked { color: var(--danger); text-decoration: line-through; }
    .player-item.selected { background: var(--glow); color: #000; }

    /* Screens */
    #login-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); z-index: 100; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    #game-over-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(50,0,0,0.9); z-index: 200; display: none; align-items: center; justify-content: center; flex-direction: column; color: var(--danger); }
    
    .shake { animation: shake 0.5s; }
    @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
  </style>
</head>
<body>

  <div id="login-screen">
    <div class="panel" style="width: 300px;">
      <h1 style="text-align:center">NETSEC LOGIN</h1>
      <input id="login-user" placeholder="Username" maxlength="10">
      <input id="login-pass" type="number" placeholder="Password (0-999)" min="0" max="999">
      <button onclick="joinGame()">CONNECT</button>
    </div>
  </div>

  <div id="game-over-screen">
    <h1 style="font-size: 60px;">YOU HAVE BEEN HACKED</h1>
    <p id="game-over-timer">System Reboot in 60s...</p>
  </div>

  <div class="app">
    
    <div class="sidebar">
      <h3>Network Scanner</h3>
      <div id="player-list" style="overflow-y: auto; flex: 1;"></div>
      
      <div class="panel" style="margin-top: 20px;">
        <h3>Attack Tool</h3>
        <label style="font-size: 10px;">Target IP:</label>
        <input id="atk-ip" readonly placeholder="Select a target..." style="opacity: 0.5">
        <input id="atk-id" type="hidden">
        
        <div style="display:flex; gap: 5px;">
          <select id="atk-proto" style="width: 40%">
             <option value="TCP">TCP</option>
             <option value="UDP">UDP</option>
          </select>
          <select id="atk-port" style="width: 60%">
            <option value="22">22 (SSH)</option>
            <option value="80">80 (HTTP)</option>
            <option value="443">443 (HTTPS)</option>
            <option value="21">21 (FTP)</option>
            <option value="3306">3306 (SQL)</option>
          </select>
        </div>
        
        <button id="btn-attack" class="danger" onclick="toggleAttack()">INITIATE ATTACK</button>
      </div>
    </div>

    <div class="main">
      <div class="top-bar">
        <div>
          USER: <strong id="my-user">...</strong> | 
          IP: <strong id="my-ip">...</strong> |
          PASS: <strong id="my-pass">...</strong>
        </div>
        <div>
          SUCCESSFUL HACKS: <strong id="my-hacks" style="color: #fff; font-size: 1.2em">0</strong>
        </div>
      </div>

      <div style="display: flex; height: 60%; gap: 20px; margin-bottom: 20px;">
        <div style="flex: 2; display:flex; flex-direction:column;">
          <h3>System Logs (IDS)</h3>
          <div id="console" class="console-log"></div>
        </div>
        
        <div style="flex: 1; display: flex; flex-direction: column;">
          <h3>Firewall Rules (Max 3)</h3>
          <div class="panel" style="flex:1;">
            <div id="rules-list" style="font-size: 12px; margin-bottom: 15px; color: #aaa;">
              No rules active.
            </div>
            
            <div style="border-top: 1px solid #333; padding-top: 10px;">
              <select id="fw-action">
                <option value="deny">DENY</option>
                <option value="allow">ALLOW</option>
              </select>
              <div style="display:flex; gap:5px;">
                <input id="fw-src" placeholder="Src IP (* for all)" value="*">
                <select id="fw-proto">
                  <option value="TCP">TCP</option>
                  <option value="UDP">UDP</option>
                </select>
              </div>
              <input id="fw-port" placeholder="Port (e.g. 22)" type="number">
              <button onclick="addRule()">ADD RULE</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    const socket = io();
    let myId = null;
    let isAttacking = false;

    // --- LOGIN ---
    function joinGame() {
      const user = document.getElementById('login-user').value;
      const pass = document.getElementById('login-pass').value;
      if(!user || !pass) return alert("Fill all fields");
      
      socket.emit('join_game', { username: user, password: pass });
      document.getElementById('login-screen').style.display = 'none';
    }

    // --- STATE UPDATES ---
    socket.on('init_state', (player) => {
      myId = player.id;
      document.getElementById('my-user').innerText = player.username;
      document.getElementById('my-ip').innerText = player.ip;
      document.getElementById('my-pass').innerText = player.password; // Recordatorio para el alumno
      document.getElementById('my-hacks').innerText = player.hacks;
      renderRules(player.firewall);
      addLog(`[SYS] Sistema iniciado. IP Asignada: ${player.ip}`);
    });

    socket.on('update_player_list', (list) => {
      const container = document.getElementById('player-list');
      container.innerHTML = '';
      list.forEach(p => {
        if (p.id === myId) return; // No mostrarse a s√≠ mismo en targets
        
        const div = document.createElement('div');
        div.className = `player-item ${p.status === 'hacked' ? 'hacked' : ''}`;
        div.innerHTML = `
          <div><strong>${p.ip}</strong> (${p.username})</div>
          <div style="font-size: 10px; color: #666">Hacks: ${p.hacks} | Status: ${p.status.toUpperCase()}</div>
        `;
        div.onclick = () => selectTarget(p);
        container.appendChild(div);
      });
    });

    // --- FIREWALL ---
    function addRule() {
      const action = document.getElementById('fw-action').value;
      const src = document.getElementById('fw-src').value || '*';
      const proto = document.getElementById('fw-proto').value;
      const port = document.getElementById('fw-port').value;

      if (!port) return alert("Specify a port");

      socket.emit('update_firewall', { action, src, proto, port });
    }

    socket.on('firewall_updated', (rules) => {
      renderRules(rules);
    });

    function renderRules(rules) {
      const list = document.getElementById('rules-list');
      if (rules.length === 0) {
        list.innerHTML = "No rules active. Default policy: ALLOW ALL";
        return;
      }
      list.innerHTML = rules.map((r, i) => 
        `<div>${i+1}. <strong>${r.action.toUpperCase()}</strong> ${r.proto}/${r.port} FROM ${r.src}</div>`
      ).join('');
    }

    // --- ATTACK ---
    function selectTarget(player) {
      if(player.status === 'hacked') return;
      document.getElementById('atk-ip').value = player.ip;
      document.getElementById('atk-id').value = player.id;
    }

    function toggleAttack() {
      if (isAttacking) {
        socket.emit('stop_attack');
        document.getElementById('btn-attack').innerText = "INITIATE ATTACK";
        document.getElementById('btn-attack').classList.add('danger');
        isAttacking = false;
      } else {
        const targetId = document.getElementById('atk-id').value;
        const port = document.getElementById('atk-port').value;
        const proto = document.getElementById('atk-proto').value;
        
        if (!targetId) return alert("Select a target first");
        
        socket.emit('start_attack', { targetId, targetPort: port, targetProto: proto });
        document.getElementById('btn-attack').innerText = "STOP ATTACK";
        document.getElementById('btn-attack').classList.remove('danger');
        isAttacking = true;
      }
    }

    socket.on('hack_result', (data) => {
      // Detener UI de ataque si ganamos
      if (isAttacking) toggleAttack();
      alert(data.msg);
    });

    // --- LOGS & GAME OVER ---
    socket.on('log', (msg) => addLog(msg));

    function addLog(msg) {
      const consoleDiv = document.getElementById('console');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      
      // Colorear si es bloqueo
      if (msg.includes('BLOQUEADO')) entry.classList.add('log-fw');
      
      // Timestamp
      const time = new Date().toLocaleTimeString();
      entry.innerText = `[${time}] ${msg}`;
      
      consoleDiv.appendChild(entry);
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    socket.on('game_over', (data) => {
      const screen = document.getElementById('game-over-screen');
      screen.style.display = 'flex';
      document.body.classList.add('shake');
      
      // Countdown visual simple
      let count = 60;
      const timer = setInterval(() => {
        count--;
        document.getElementById('game-over-timer').innerText = `System Reboot in ${count}s...`;
        if (count <= 0) clearInterval(timer);
      }, 1000);
    });

    socket.on('game_reset', (newState) => {
      document.getElementById('game-over-screen').style.display = 'none';
      document.body.classList.remove('shake');
      // Actualizar datos locales
      socket.emit('join_game', { username: newState.username, password: newState.password }); 
    });

  </script>
</body>
</html>