<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>NETSEC WARGAMES v3</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root { --bg: #050505; --panel: rgba(10, 20, 10, 0.95); --glow: #00ff7f; --danger: #ff3333; --muted: #446644; }
    * { box-sizing: border-box; }
    html,body { height: 100%; margin: 0; background: var(--bg); font-family: "Courier New", monospace; color: var(--glow); overflow: hidden; }
    
    /* Layout */
    .app { display: flex; height: 100%; width: 100%; }
    .sidebar { width: 300px; border-right: 1px solid #004400; padding: 20px; display: flex; flex-direction: column; background: rgba(0,20,0,0.3); }
    .main { flex: 1; display: flex; flex-direction: column; padding: 20px; position: relative; height: 100%; }
    .top-bar { height: 40px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--muted); padding-bottom: 10px; margin-bottom: 10px; flex-shrink: 0; }
    .game-content { display: flex; flex: 1; gap: 20px; overflow: hidden; }
    .log-column { flex: 2; display: flex; flex-direction: column; height: 100%; }
    .rules-column { flex: 1; display: flex; flex-direction: column; height: 100%; }

    /* UI Components */
    h1, h2, h3 { margin: 0 0 10px 0; font-weight: normal; letter-spacing: 1px; text-transform: uppercase; font-size: 16px; flex-shrink: 0;}
    .panel { border: 1px solid var(--muted); background: var(--panel); padding: 15px; margin-bottom: 20px; border-radius: 4px; }
    
    input, select { background: #001100; border: 1px solid var(--muted); color: var(--glow); padding: 5px; font-family: inherit; width: 100%; margin-bottom: 5px; }
    
    /* REMOVER FLECHAS/SPINNERS DE INPUTS */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    button { background: var(--muted); color: #000; border: none; padding: 8px; cursor: pointer; font-weight: bold; font-family: inherit; width: 100%; transition: 0.2s; }
    button:hover { background: var(--glow); }
    button:disabled { background: #333; color: #666; cursor: not-allowed; }
    button.danger { background: #500; color: #fff; }

    /* Logs */
    .console-log { flex: 1; background: #000; border: 1px solid var(--muted); padding: 10px; overflow-y: auto; font-size: 13px; white-space: pre-wrap; opacity: 0.9; display: flex; flex-direction: column; }
    .console-content { margin-top: auto; }
    .log-entry { margin-bottom: 3px; border-bottom: 1px solid #111; padding-bottom: 2px;}
    .log-fw { color: #ffff00; font-weight: bold; }
    .log-atk { color: #00ffff; }
    .log-err { color: var(--danger); }
    
    .player-item { padding: 8px; border-bottom: 1px solid #112211; cursor: pointer; }
    .player-item:hover { background: #002200; }
    .player-item.hacked { color: var(--danger); text-decoration: line-through; pointer-events: none; }
    
    #login-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); z-index: 100; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    #game-over-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(50,0,0,0.95); z-index: 200; display: none; align-items: center; justify-content: center; flex-direction: column; color: var(--danger); }
  </style>
</head>
<body>

  <div id="login-screen">
    <div class="panel" style="width: 300px;">
      <h1 style="text-align:center">NETSEC LOGIN</h1>
      <input id="login-user" placeholder="Usuario" maxlength="10">
      <input id="login-pass" type="number" placeholder="Password (0-99)" min="0" max="99">
      <button onclick="joinGame()">CONECTAR</button>
    </div>
  </div>

  <div id="game-over-screen">
    <h1 style="font-size: 60px;">ELIMINADO</h1>
    <p>Has sido hackeado. Fin del juego.</p>
  </div>

  <div class="app">
    <div class="sidebar">
      <h3>Scanner de Red</h3>
      <div id="player-list" style="overflow-y: auto; flex: 1; border: 1px solid #222; margin-bottom: 20px;"></div>
      
      <div class="panel" style="flex-shrink: 0;">
        <h3>Attack Tool</h3>
        <label style="font-size: 10px;">Target IP:</label>
        <input id="atk-ip" readonly placeholder="Selecciona una IP..." style="opacity: 0.5">
        <input id="atk-id" type="hidden">
        
        <div style="display:flex; gap: 5px;">
          <select id="atk-proto" style="width: 40%"><option value="TCP">TCP</option><option value="UDP">UDP</option></select>
          <select id="atk-port" style="width: 60%">
            <option value="22">22 (SSH)</option>
            <option value="80">80 (HTTP)</option>
            <option value="443">443 (HTTPS)</option>
            <option value="21">21 (SFTP)</option>
          </select>
        </div>
        
        <button id="btn-attack" class="danger" onclick="toggleAttack()">INICIAR ATAQUE</button>
        <div id="cooldown-msg" style="color: yellow; font-size: 10px; text-align: center; margin-top: 5px; display: none;">COOLDOWN ACTIVO...</div>
      </div>
    </div>

    <div class="main">
      <div class="top-bar">
        <div>USR: <strong id="my-user">...</strong> | IP: <strong id="my-ip">...</strong> | PASS: <strong id="my-pass">...</strong></div>
        <div>HACKS: <strong id="my-hacks" style="color: #fff; font-size: 1.2em">0</strong></div>
      </div>

      <div class="game-content">
        <div class="log-column">
          <h3>SISTEMA IDS / LOGS</h3>
          <div id="console" class="console-log">
             <div class="console-content" id="console-inner"></div>
          </div>
        </div>
        
        <div class="rules-column">
          <h3>Firewall (Max 3)</h3>
          <div class="panel">
            <div id="rules-list" style="font-size: 12px; margin-bottom: 15px; color: #aaa; min-height: 50px;">Sin reglas activas.</div>
            <div style="border-top: 1px solid #333; padding-top: 10px;">
              <select id="fw-action"><option value="deny">DENY (Denegar)</option><option value="allow">ALLOW (Permitir)</option></select>
              <div style="display:flex; gap:5px;">
                <input id="fw-src" placeholder="IP Origen (Ej: 10.12.0.5)">
                <select id="fw-proto"><option value="TCP">TCP</option><option value="UDP">UDP</option></select>
              </div>
              <input id="fw-port" type="text" placeholder="Puerto (Ej. 22)">
              <button onclick="addRule()">AGREGAR REGLA</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    let myId = null;
    let isAttacking = false;
    let inCooldown = false;

    // --- LOGIN ---
    function joinGame() {
      const user = document.getElementById('login-user').value;
      const pass = document.getElementById('login-pass').value;
      if(!user || !pass) return alert("Completa los campos");
      if(pass < 0 || pass > 99) return alert("Password debe ser 0-99");
      
      socket.emit('join_game', { username: user, password: pass });
      document.getElementById('login-screen').style.display = 'none';
    }

    socket.on('init_state', (player) => {
      myId = player.id;
      document.getElementById('my-user').innerText = player.username;
      document.getElementById('my-ip').innerText = player.ip;
      document.getElementById('my-pass').innerText = player.password;
      document.getElementById('my-hacks').innerText = player.hacks;
      renderRules(player.firewall);
      addLog(`[SYS] Sistema online. IP: ${player.ip}`);
    });

    socket.on('update_player_list', (list) => {
      const container = document.getElementById('player-list');
      container.innerHTML = '';
      list.forEach(p => {
        if (p.id === myId) return;
        const div = document.createElement('div');
        div.className = `player-item ${p.status === 'hacked' ? 'hacked' : ''}`;
        div.innerHTML = `<div><strong>${p.ip}</strong> (${p.username})</div>`;
        div.onclick = () => selectTarget(p);
        container.appendChild(div);
      });
    });

    // --- FIREWALL ---
    function addRule() {
      const action = document.getElementById('fw-action').value;
      const src = document.getElementById('fw-src').value;
      const proto = document.getElementById('fw-proto').value;
      const portInput = document.getElementById('fw-port').value;

      // 1. Validar Puerto (Solo números)
      if (!/^\d+$/.test(portInput)) {
        alert("Error: El puerto debe contener solo números.");
        return;
      }

      // 2. Validar IP (No permitir *)
      if (!src || src.includes('*')) {
        alert("Error: Debes especificar una IP directa (No se permite *).");
        return;
      }

      socket.emit('update_firewall', { action, src, proto, port: portInput });
      
      // Limpiar campos
      document.getElementById('fw-src').value = '';
      document.getElementById('fw-port').value = '';
    }

    socket.on('firewall_updated', (rules) => renderRules(rules));

    function renderRules(rules) {
      const list = document.getElementById('rules-list');
      if (rules.length === 0) { list.innerHTML = "Sin reglas activas."; return; }
      list.innerHTML = rules.map((r, i) => 
        `<div>${i+1}. <strong>${r.action.toUpperCase()}</strong> ${r.proto}/${r.port} DESDE ${r.src}</div>`
      ).join('');
    }

    // --- ATAQUE & COOLDOWN ---
    function selectTarget(player) {
      if(player.status === 'hacked') return;
      if(isAttacking) return alert("Stop Attack primero.");
      
      document.getElementById('atk-ip').value = player.ip;
      document.getElementById('atk-id').value = player.id;
    }

    function toggleAttack() {
      const btn = document.getElementById('btn-attack');
      
      if (isAttacking) {
        // DETENER
        socket.emit('stop_attack');
        isAttacking = false;
        btn.innerText = "INICIAR ATAQUE";
        btn.classList.add('danger');
      } else {
        // INICIAR
        if(inCooldown) return;
        
        const targetId = document.getElementById('atk-id').value;
        const port = document.getElementById('atk-port').value;
        const proto = document.getElementById('atk-proto').value;
        
        if (!targetId) return alert("Selecciona un objetivo.");
        
        socket.emit('start_attack', { targetId, targetPort: port, targetProto: proto });
        isAttacking = true;
        btn.innerText = "Stop Attack";
        btn.classList.remove('danger');
      }
    }

    socket.on('cooldown_start', (seconds) => {
      inCooldown = true;
      const btn = document.getElementById('btn-attack');
      const msg = document.getElementById('cooldown-msg');
      
      btn.disabled = true;
      msg.style.display = 'block';
      let left = seconds;
      
      btn.innerText = `Cooldown (${left})...`;
      
      const interval = setInterval(() => {
        left--;
        btn.innerText = `Cooldown (${left})...`;
        if (left <= 0) {
          clearInterval(interval);
          inCooldown = false;
          btn.disabled = false;
          btn.innerText = "INICIAR ATAQUE";
          btn.classList.add('danger');
          msg.style.display = 'none';
        }
      }, 1000);
    });

    socket.on('hack_result', (data) => {
      if (isAttacking) toggleAttack(); 
      alert(data.msg);
    });

    // --- LOGS ---
    socket.on('log', (msg) => addLog(msg));

    function addLog(msg) {
      const inner = document.getElementById('console-inner');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      if (msg.includes('BLOQUEADO')) entry.classList.add('log-fw');
      if (msg.includes('[ERR]')) entry.classList.add('log-err');
      if (msg.includes('Iniciando')) entry.classList.add('log-atk');
      
      const time = new Date().toLocaleTimeString();
      entry.innerText = `[${time}] ${msg}`;
      
      inner.appendChild(entry);
      document.getElementById('console').scrollTop = document.getElementById('console').scrollHeight;
    }

    socket.on('game_over', () => {
      document.getElementById('game-over-screen').style.display = 'flex';
    });
  </script>
</body>
</html>
